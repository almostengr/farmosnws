<?php
/**
 * @file
 * Code for the FarmOS NWS feature.
 */

/**
 *
 * Implements hook_menu()
 * 
 * @return Array of menu links
 */
function farmosnws_menu() {
  $items = array();
  
  $items['admin/config/services/farmosnws'] = array(
    'title' => t('FarmOS NWS Settings'),
    'description' => 'Add and remove additional feeds to be pulled by FarmOS NWS',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('farmosnws_admin_form'),
    'access arguments' => array('access administration pages'),
  	'file' => 'farmosnws.admin.inc',
  );
    
  return $items;
}

/**
 *
 * Implements hook_cron()
 */
function farmosnws_cron() {
  farmosnws_get_xml();
  // farmosnws_load_xml();
}

/**
 *
 * Check and create if necessary the path where the weather feeds will be stored.
 * 
 * @param string feedpath
 *   String to the path that contains the feeds 
 *   
 * @return Returns whether the directory exists or not.
 */
function farmosnws_create_feed_dir($feedpath) {
  $mkdirsuccess = NULL;
  
  // check to see if the feeds directory exists. If not attempt to create it.
  if ( is_dir($feedpath) == FALSE ) {
    $mkdirsuccess = mkdir($weatherfeedsdir, 755);
    
    // verify directory exists
    if ( $feedpath == FALSE ){
      watchdog('farmosnws', 'Unable to create the weather feed directory.', array(), WATCHDOG_ERROR, NULL);
    }
    else {
      watchdog('farmosnws', 'Created weather feed directory.', array(), WATCHDOG_INFO, NULL);
    } // end if
  }
  else {
    // skipping actions
    $mkdirsuccess = TRUE;
  } // end if
  
  return $mkdirsuccess;
}

/**
 *
 * Get the weather data from the NWS
 */
function farmosnws_get_xml() {
  $weatherfeedsdir = variable_get('farmosnws_weather_feeds_dir');
  
  $locations = variable_get('farmosnws_locations', '');
  $location_array = explode(",", $locations);
  
  foreach ($location_array as $loc) {
    // remove carriage returns and new lines
    $loc = str_replace(" ", "", str_replace("\r", "", str_replace("\n", "", $loc)));
    // $loc = str_replace(" ", "", $loc);

    $weather_feed_name = $weatherfeedsdir . '/' . uniqid($loc, FALSE) . '.xml';
    $url = "http://w1.weather.gov/xml/current_obs/" . $loc . ".xml";
  
    watchdog('farmosnws', $url, array(), WATCHDOG_DEBUG, NULL);
    
    watchdog('farmosnws', 'Getting weather data for ' . $loc, array(), WATCHDOG_INFO, NULL);
    
    $response = drupal_http_request($url, array());
    
//     watchdog('farmosnws', 'Response code: ' . $response->code, array(), WATCHDOG_INFO, NULL);

 // watchdog('farmosnws', 'Response code: ' . $response->code . '. '  $response->error, array(), WATCHDOG_ERROR, NULL);
    
    // if error occurs when performing the request
    if ( $response->error ) {
      watchdog('farmosnws', 'Response code: ' . $response->code . '. ' . $response->error, array(), WATCHDOG_ERROR, NULL);
      drupal_set_message($response->error, 'error', FALSE);
    }
    else{
      // if no errors occur when performing the request
      watchdog('farmosnws', 'Response code: ' . $response->code, array(), WATCHDOG_INFO, NULL);

      // if the directory doesnt exist, then create it with 755 permissions
      $direxist = farmosnws_create_feed_dir($weatherfeedsdir);
      
      if ( $direxist == TRUE ) {
        // save the contents retrieved
        file_put_contents($weather_feed_name, $response->data);
        watchdog('farmosnws', 'Weather data saved to ' . $weather_feed_name, array(), WATCHDOG_INFO, NULL);
        
        farmosnws_load_xml($weather_feed_name);
      }
      else {
        drupal_set_message("Feed could not be downloaded because the directory does not exist. Please verify that Drupal has write access and try again.", 'error', FALSE);
        watchdog('farmosnws', 'Feed could not be downloaded because the directory does not exist.', array(), WATCHDOG_ERROR, NULL);
      }
    } // end else
  } // end foreach
} // end function

/**
 * 
 * @param unknown $feedfilename
 * 
 * @tutorial http://audiblecode.com/blog/programmatically-create-and-update-field-collection-item-node-entity-api
 * @tutorial http://drupal.org/node/1842304
 */
function farmosnws_load_xml($feedfilename) {
  global $user;

  // load the file
  $xml = simplexml_load_file($feedfilename);
  
  /*
  $qty = entity_create('farm_quantity', array('type' => 'farm_quantity'));
  $qty->value = $xml->temp_f;
  entity_save('farm_quantity', $qty);
*/
  
  $log = entity_create('log', array('type' => 'farm_observation'));
  $log_wrapper = entity_metadata_wrapper('log', $log);
  $log_wrapper->field_farm_notes->set($xml->temp_c);
  $log_wrapper->field_farm_quantity = intval($xml->temp_f);
  $log_wrapper->done = 1;
  $log_wrapper->name = $xml->location . " at " . $xml->observation_time_rfc822;
  $log_wrapper->timestamp = strtotime($xml->observation_time_rfc822);
  $log_wrapper->save();
   
  $qty = entity_create('farm_quantity', array('type' => 'farm_quantity'));
  $qty->value = strval($xml->temp_f);
  $qty->units = 'Fahrenheit';
  $qty->id = $log_wrapper->id;
  entity_save('farm_quantity', $qty);
  
  // $etl = entity_load('log', array('102'));
  // print_r($etl);

  // print("Temperature " . $xml->temp_f . "\r\n");
  
  watchdog('farmosnws', 'Temperature data saved from ' . $feedfilename, array(), WATCHDOG_INFO, NULL);
  
  // log the relative humidity
    
  // log the wind speed
  
  // log the wind direction
 
  // log the barametric pressure
  
  // log the visibility
}

